<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ចំណាត់ថ្នាក់ពិន្ទុសិស្ស - ថ្នាក់ 10A</title>
    <!-- Tailwind CSS -->
    <script src="./tailwind.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            font-family: 'Khmer OS Battambang', sans-serif;
        }
        
        @font-face {
            font-family: 'Khmer OS Battambang';
            src: url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang&display=swap');
        }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }

        .student-row:hover {
            background-color: #f7fafc;
        }

        .grade-A { background-color: #dcfce7; color: #166534; }
        .grade-B { background-color: #dbeafe; color: #1e40af; }
        .grade-C { background-color: #fef3c7; color: #92400e; }
        .grade-D { background-color: #fde68a; color: #92400e; }
        .grade-E { background-color: #fecaca; color: #991b1b; }
        .grade-F { background-color: #f3f4f6; color: #6b7280; }

        .progress-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background-color: #e5e7eb;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .mobile-sticky-column {
                position: sticky;
                left: 0;
                z-index: 5;
                background-color: white;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
        }

        /* Print styles for report */
        @media print {
            .no-print { display: none !important; }
            body { 
                font-size: 10pt; 
                background: white !important;
            }
            .table-container { overflow: visible; }
            
            /* Report page specific */
            .report-page {
                padding: 0.5cm;
                margin: 0;
                width: 100%;
            }
            
            .report-header {
                text-align: center;
                margin-bottom: 10px;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
            }
            
            .report-title {
                font-size: 16pt;
                font-weight: bold;
                margin-bottom: 3px;
            }
            
            .report-subtitle {
                font-size: 12pt;
                margin-bottom: 3px;
            }
            
            .report-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
            }
            
            .report-table th {
                background-color: #f0f0f0;
                border: 1px solid #000;
                padding: 3px;
                text-align: center;
                font-weight: bold;
            }
            
            .report-table td {
                border: 1px solid #000;
                padding: 3px;
                text-align: center;
            }
            
            .report-footer {
                margin-top: 10px;
                padding-top: 5px;
                border-top: 1px solid #000;
                font-size: 9pt;
            }
            
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="header-gradient text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-3 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <a href="javascript:history.back()" class="bg-white p-2 rounded-full hover:bg-gray-100 transition no-print">
                        <i class="fas fa-arrow-left text-purple-700 text-sm"></i>
                    </a>
                    <div>
                        <h1 class="text-lg font-bold">ចំណាត់ថ្នាក់ពិន្ទុសិស្ស</h1>
                        <p class="text-xs opacity-90">ថ្នាក់ 10A - តាមមធ្យមភាគពិន្ទុ</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 no-print">
                    <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-file-excel"></i>
                        <span class="hidden md:inline ml-1">Export Excel</span>
                    </button>
                    <button onclick="generateReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-print"></i>
                        <span class="hidden md:inline ml-1">របាយការណ៍</span>
                    </button>
                    <button onclick="viewStudentScores()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-eye"></i>
                        <span class="hidden md:inline ml-1">មើល</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 py-4">
        <!-- Simplified Statistics -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-gray-600 text-xs mb-1">មធ្យមភាគថ្នាក់</p>
                    <p class="text-xl font-bold text-blue-600" id="classAverage">0.00</p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-gray-600 text-xs mb-1">ខ្ពស់បំផុត</p>
                    <p class="text-xl font-bold text-green-600" id="highestAverage">0.00</p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-gray-600 text-xs mb-1">ទាបបំផុត</p>
                    <p class="text-xl font-bold text-red-600" id="lowestAverage">0.00</p>
                </div>
            </div>
        </div>

        <!-- Grade Distribution -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-3 border-b">
                <h3 class="font-bold text-gray-800 text-sm">ការចែកចាយកម្រិតពិន្ទុ</h3>
            </div>
            <div class="p-3">
                <div id="gradeDistribution" class="grid grid-cols-3 md:grid-cols-6 gap-2">
                    <!-- Grades will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Ranking Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
            <div class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 border-b">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-gray-800 text-sm">តារាងចំណាត់ថ្នាក់</h2>
                    <div class="text-xs text-gray-600">
                        <i class="fas fa-sort-amount-down mr-1"></i>តម្រៀបតាមមធ្យមភាគ
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="py-2 px-2 text-center font-medium">ល.រ</th>
                            <th class="py-2 px-2 text-left font-medium">ឈ្មោះសិស្ស</th>
                            <th class="py-2 px-2 text-left font-medium">លេខសម្គាល់</th>
                            <th class="py-2 px-2 text-center font-medium">ភេទ</th>
                            <th class="py-2 px-2 text-center font-medium">មធ្យមភាគ</th>
                            <th class="py-2 px-2 text-center font-medium">កម្រិត</th>
                            <th class="py-2 px-2 text-center font-medium text-red-600">ចំណាត់ថ្នាក់</th>
                            <th class="py-2 px-2 text-center font-medium">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody" class="divide-y divide-gray-100">
                        <!-- Ranking table will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="p-2 border-t bg-gray-50 text-xs text-gray-600">
                <div class="flex justify-between items-center">
                    <div>
                        <i class="fas fa-info-circle mr-1"></i>
                        <span>ពិន្ទុនីមួយៗមានពី 0-10 ពិន្ទុ</span>
                    </div>
                    <div id="lastUpdated" class="text-gray-500">
                        <i class="fas fa-sync-alt mr-1"></i>កំពុងអាប់ដេត...
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs mb-6">
            <h3 class="font-bold text-yellow-800 mb-1"><i class="fas fa-info-circle mr-1"></i>ការពន្យល់</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                    <p class="font-medium text-gray-700 mb-1">កម្រិតពិន្ទុ:</p>
                    <div class="flex flex-wrap gap-1">
                        <span class="px-2 py-1 rounded grade-A">A (9.0-10)</span>
                        <span class="px-2 py-1 rounded grade-B">B (8.0-8.9)</span>
                        <span class="px-2 py-1 rounded grade-C">C (7.0-7.9)</span>
                        <span class="px-2 py-1 rounded grade-D">D (6.0-6.9)</span>
                        <span class="px-2 py-1 rounded grade-E">E (5.0-5.9)</span>
                        <span class="px-2 py-1 rounded grade-F">F (0-4.9)</span>
                    </div>
                </div>
                <div>
                    <p class="font-medium text-gray-700 mb-1">ការគណនា:</p>
                    <ul class="text-gray-600 space-y-0.5">
                        <li>• ពិន្ទុសរុប = ផលបូកពិន្ទុទាំង ១២ មុខវិជ្ជា</li>
                        <li>• មធ្យមភាគ = ពិន្ទុសរុប ÷ ១២ (0-10)</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Scores Page (Hidden by default) -->
    <div id="studentScoresPage" class="hidden">
        <header class="header-gradient text-white shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-3 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="goBackToRanking()" class="bg-white p-2 rounded-full hover:bg-gray-100 transition">
                            <i class="fas fa-arrow-left text-purple-700 text-sm"></i>
                        </button>
                        <div>
                            <h1 class="text-lg font-bold">ពិន្ទុមុខវិជ្ជាលម្អិត</h1>
                            <p class="text-xs opacity-90" id="studentDetailTitle"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="printStudentScores()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">
                            <i class="fas fa-print"></i>
                            <span class="hidden md:inline ml-1">Print</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-3 py-4">
            <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                <div class="p-4 bg-gradient-to-r from-blue-50 to-blue-100 border-b">
                    <h2 class="font-bold text-gray-800" id="scorePageTitle">ពិន្ទុមុខវិជ្ជា</h2>
                </div>
                
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-gray-600 text-xs">លេខសម្គាល់</p>
                            <p class="font-bold" id="scoreStudentId"></p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-gray-600 text-xs">ភេទ</p>
                            <p class="font-bold" id="scoreStudentGender"></p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-gray-600 text-xs">មធ្យមភាគ</p>
                            <p class="font-bold text-blue-600" id="scoreStudentAverage"></p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-gray-600 text-xs">កម្រិតសរុប</p>
                            <span class="font-bold" id="scoreStudentGrade"></span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="py-2 px-3 text-left">ល.រ</th>
                                    <th class="py-2 px-3 text-left">មុខវិជ្ជា</th>
                                    <th class="py-2 px-3 text-center">ពិន្ទុ (0-10)</th>
                                    <th class="py-2 px-3 text-center">កម្រិត</th>
                                </tr>
                            </thead>
                            <tbody id="studentScoresTable">
                                <!-- Scores will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 text-xs">សង្ខេបស្ថានភាព</p>
                                <p class="text-sm font-bold text-blue-600" id="scoreSummary"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-600 text-xs">ចំណាត់ថ្នាក់</p>
                                <span class="font-bold text-red-600" id="scoreRank"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Page (Hidden by default, only for printing) -->
    <div id="reportPage" class="hidden">
        <div class="report-page">
            <!-- Report Header -->
            <div class="report-header">
                <div class="report-title">របាយការណ៍ពិន្ទុសិស្ស</div>
                <div class="report-subtitle">ថ្នាក់ 10A - ឆ្នាំសិក្សា 2024-2025</div>
                <div class="text-xs">កាលបរិច្ឆេទ៖ <span id="reportDate"></span></div>
            </div>
            
            <!-- Class Information -->
            <div style="margin: 10px 0; font-size: 10pt;">
                <div><strong>ព័ត៌មានថ្នាក់៖</strong></div>
                <div>មធ្យមភាគថ្នាក់៖ <span id="reportClassAvg"></span></div>
                <div>ចំនួនសិស្សសរុប៖ <span id="reportTotalStudents"></span> នាក់</div>
            </div>
            
            <!-- Main Report Table -->
            <table class="report-table">
                <thead>
                    <tr>
                        <th rowspan="2">ល.រ</th>
                        <th rowspan="2">ឈ្មោះសិស្ស</th>
                        <th rowspan="2">លេខសម្គាល់</th>
                        <th colspan="12">ពិន្ទុមុខវិជ្ជា</th>
                        <th rowspan="2">សរុប</th>
                        <th rowspan="2">មធ្យម</th>
                        <th rowspan="2">កម្រិត</th>
                        <th rowspan="2">ចំណាត់ថ្នាក់</th>
                    </tr>
                    <tr>
                        <th>ខ្មែរ</th>
                        <th>គណិត</th>
                        <th>រូបវិទ្យា</th>
                        <th>គីមី</th>
                        <th>ជីវវិទ្យា</th>
                        <th>ប្រវត្តិ</th>
                        <th>ភូមិវិទ្យា</th>
                        <th>អង់គ្លេស</th>
                        <th>សីលធម៌</th>
                        <th>ព័ត៌មាន</th>
                        <th>អប់រំកាយ</th>
                        <th>សិល្បៈ</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <!-- Report data will be populated here -->
                </tbody>
            </table>
            
            <!-- Footer Notes -->
            <div class="report-footer">
                <div><strong>កំណត់សម្គាល់៖</strong></div>
                <div>១. ពិន្ទុទាំងអស់គិតជាល្បឿន 0-10</div>
                <div>២. កម្រិតពិន្ទុ៖ A(9.0-10), B(8.0-8.9), C(7.0-7.9), D(6.0-6.9), E(5.0-5.9), F(0-4.9)</div>
                <div>៣. ចំណាត់ថ្នាក់គិតតាមមធ្យមភាគ (ខ្ពស់ → ទាប)</div>
            </div>
        </div>
    </div>

    <script>
        // Subjects list
        const subjects = [
            "ភាសាខ្មែរ",
            "គណិតវិទ្យា", 
            "រូបវិទ្យា",
            "គីមីវិទ្យា",
            "ជីវវិទ្យា",
            "ប្រវត្តិវិទ្យា",
            "ភូមិវិទ្យា",
            "អង់គ្លេស",
            "សីលធម៌-ពលរដ្ឋ",
            "ព័ត៌មានវិទ្យា",
            "អប់រំកាយ",
            "សិល្បៈ"
        ];

        // Global variables
        let students = [];
        let scores = {};
        let rankedStudents = [];

        // Initialize data
        function initializeData() {
            // Load students from class10A_students
            const savedStudents = localStorage.getItem('class10A_students');
            students = savedStudents ? JSON.parse(savedStudents) : [];
            
            // Load scores from class10A_scores
            const savedScores = localStorage.getItem('class10A_scores');
            scores = savedScores ? JSON.parse(savedScores) : {};
            
            // Calculate rankings
            calculateRankings();
            
            // Update display
            updateAllDisplays();
            
            // Update last updated time
            updateLastUpdated();
        }

        // Calculate total score
        function calculateTotal(scoresArray) {
            if (!scoresArray) return 0;
            return scoresArray.reduce((sum, score) => sum + score, 0);
        }

        // Calculate average (0-10)
        function calculateAverage(scoresArray) {
            if (!scoresArray || scoresArray.length === 0) return 0;
            const total = calculateTotal(scoresArray);
            return total / scoresArray.length;
        }

        // Get grade from score (0-10 scale)
        function getGradeFromScore(score) {
            if (score >= 9.0) return 'A';
            if (score >= 8.0) return 'B';
            if (score >= 7.0) return 'C';
            if (score >= 6.0) return 'D';
            if (score >= 5.0) return 'E';
            return 'F';
        }

        // Get grade color class
        function getGradeColorClass(grade) {
            switch(grade) {
                case 'A': return 'grade-A';
                case 'B': return 'grade-B';
                case 'C': return 'grade-C';
                case 'D': return 'grade-D';
                case 'E': return 'grade-E';
                case 'F': return 'grade-F';
                default: return 'grade-F';
            }
        }

        // Calculate rankings
        function calculateRankings() {
            // Prepare student data with scores
            const studentsWithScores = students.map(student => {
                const studentScores = scores[student.id] || Array(12).fill(0);
                const total = calculateTotal(studentScores);
                const average = calculateAverage(studentScores);
                const grade = getGradeFromScore(average);
                
                return {
                    ...student,
                    scores: studentScores,
                    total: total,
                    average: average,
                    grade: grade
                };
            });
            
            // Sort by average (descending)
            rankedStudents = studentsWithScores.sort((a, b) => b.average - a.average);
            
            // Add ranking positions (handle ties)
            let currentRank = 1;
            let previousAverage = null;
            let skipCount = 0;
            
            rankedStudents.forEach((student, index) => {
                if (previousAverage !== null && Math.abs(student.average - previousAverage) < 0.01) {
                    // Same average as previous student (tie)
                    skipCount++;
                    student.rank = currentRank - 1;
                } else {
                    // Different average
                    currentRank += skipCount;
                    skipCount = 0;
                    student.rank = currentRank;
                    currentRank++;
                }
                previousAverage = student.average;
            });
        }

        // Update all displays
        function updateAllDisplays() {
            updateStatistics();
            updateGradeDistribution();
            updateRankingTable();
        }

        // Update statistics
        function updateStatistics() {
            if (rankedStudents.length === 0) return;
            
            // Calculate class statistics
            const averages = rankedStudents.map(s => s.average);
            const classAverage = averages.reduce((sum, avg) => sum + avg, 0) / averages.length;
            const highestAverage = Math.max(...averages);
            const lowestAverage = Math.min(...averages);
            
            document.getElementById('classAverage').textContent = classAverage.toFixed(2);
            document.getElementById('highestAverage').textContent = highestAverage.toFixed(2);
            document.getElementById('lowestAverage').textContent = lowestAverage.toFixed(2);
        }

        // Update grade distribution
        function updateGradeDistribution() {
            const gradeCounts = {
                'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0, 'F': 0
            };
            
            rankedStudents.forEach(student => {
                gradeCounts[student.grade]++;
            });
            
            const container = document.getElementById('gradeDistribution');
            let html = '';
            
            ['A', 'B', 'C', 'D', 'E', 'F'].forEach(grade => {
                const count = gradeCounts[grade];
                const percentage = rankedStudents.length > 0 
                    ? Math.round((count / rankedStudents.length) * 100) 
                    : 0;
                
                html += `
                    <div class="text-center">
                        <div class="${getGradeColorClass(grade)} p-2 rounded-lg">
                            <div class="font-bold">${grade}</div>
                            <div class="text-xs mt-1">${count} នាក់</div>
                            <div class="text-xs opacity-75">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update ranking table
        function updateRankingTable() {
            const tableBody = document.getElementById('rankingTableBody');
            let html = '';
            
            rankedStudents.forEach((student, index) => {
                const rowNumber = index + 1;
                
                html += `
                    <tr class="student-row">
                        <td class="py-2 px-2 text-center font-medium text-gray-900">
                            ${rowNumber}
                        </td>
                        <td class="py-2 px-2 font-medium">
                            ${student.name}
                        </td>
                        <td class="py-2 px-2 text-sm font-mono">
                            ${student.id}
                        </td>
                        <td class="py-2 px-2 text-center">
                            <span class="px-2 py-0.5 rounded-full text-xs ${
                                student.gender === 'male' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'
                            }">
                                ${student.gender === 'male' ? 'ប្រុស' : 'ស្រី'}
                            </span>
                        </td>
                        <td class="py-2 px-2 text-center">
                            <div class="font-bold">${student.average.toFixed(2)}</div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill ${getGradeColorClass(student.grade)}" 
                                     style="width: ${student.average * 10}%"></div>
                            </div>
                        </td>
                        <td class="py-2 px-2 text-center">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${getGradeColorClass(student.grade)}">
                                ${student.grade}
                            </span>
                        </td>
                        <td class="py-2 px-2 text-center font-bold text-red-600">
                            ${student.rank}
                        </td>
                        <td class="py-2 px-2 text-center">
                            <button onclick="viewStudentScores('${student.id}')" 
                                    class="px-2 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 text-xs">
                                <i class="fas fa-eye mr-1"></i>មើល
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // Generate and print report
        function generateReport() {
            if (rankedStudents.length === 0) {
                alert('មិនមានទិន្នន័យសិស្សទេ!');
                return;
            }
            
            // Prepare report data
            const now = new Date();
            const dateString = now.toLocaleDateString('km-KH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate class statistics
            const averages = rankedStudents.map(s => s.average);
            const classAverage = averages.reduce((sum, avg) => sum + avg, 0) / averages.length;
            
            // Update report header
            document.getElementById('reportDate').textContent = dateString;
            document.getElementById('reportClassAvg').textContent = classAverage.toFixed(2);
            document.getElementById('reportTotalStudents').textContent = rankedStudents.length;
            
            // Populate report table
            const reportBody = document.getElementById('reportTableBody');
            let reportHtml = '';
            
            rankedStudents.forEach((student, index) => {
                reportHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left; padding-left: 5px;">${student.name}</td>
                        <td>${student.id}</td>
                        <td>${student.scores[0]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[1]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[2]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[3]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[4]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[5]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[6]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[7]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[8]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[9]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[10]?.toFixed(2) || '0.00'}</td>
                        <td>${student.scores[11]?.toFixed(2) || '0.00'}</td>
                        <td>${student.total.toFixed(2)}</td>
                        <td>${student.average.toFixed(2)}</td>
                        <td>${student.grade}</td>
                        <td style="font-weight: bold; color: #dc2626;">${student.rank}</td>
                    </tr>
                `;
            });
            
            reportBody.innerHTML = reportHtml;
            
            // Store current display state
            const originalMain = document.querySelector('main').style.display;
            const originalHeader = document.querySelector('header').style.display;
            
            // Hide main page
            document.querySelector('main').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            
            // Show report page
            document.getElementById('reportPage').classList.remove('hidden');
            
            // Print report
            window.print();
            
            // Restore original state
            setTimeout(() => {
                document.querySelector('main').style.display = originalMain;
                document.querySelector('header').style.display = originalHeader;
                document.getElementById('reportPage').classList.add('hidden');
            }, 100);
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('km-KH', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            const dateString = now.toLocaleDateString('km-KH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('lastUpdated').innerHTML = `
                <i class="fas fa-clock mr-1"></i>អាប់ដេត ${timeString} ថ្ងៃ ${dateString}
            `;
        }

        // View student scores - navigates to scores page
        function viewStudentScores(studentId) {
            // Hide ranking page
            document.querySelector('main').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            
            // Show scores page
            document.getElementById('studentScoresPage').classList.remove('hidden');
            
            // If studentId is provided, show that student's scores
            if (studentId) {
                loadStudentScores(studentId);
            } else {
                // Otherwise show first student's scores
                if (rankedStudents.length > 0) {
                    loadStudentScores(rankedStudents[0].id);
                }
            }
        }

        // Load student scores into the scores page
        function loadStudentScores(studentId) {
            const student = rankedStudents.find(s => s.id === studentId);
            if (!student) return;
            
            // Set basic info
            document.getElementById('studentDetailTitle').textContent = `${student.name} - ${student.id}`;
            document.getElementById('scorePageTitle').textContent = `ពិន្ទុមុខវិជ្ជា - ${student.name}`;
            document.getElementById('scoreStudentId').textContent = student.id;
            document.getElementById('scoreStudentGender').textContent = student.gender === 'male' ? 'ប្រុស' : 'ស្រី';
            document.getElementById('scoreStudentAverage').textContent = student.average.toFixed(2);
            document.getElementById('scoreStudentGrade').textContent = student.grade;
            document.getElementById('scoreStudentGrade').className = `font-bold ${getGradeColorClass(student.grade)}`;
            document.getElementById('scoreRank').textContent = `ទី ${student.rank}`;
            
            // Calculate summary
            const subjectsWithScores = student.scores.filter(score => score > 0).length;
            document.getElementById('scoreSummary').textContent = 
                `បានបញ្ចូលពិន្ទុ ${subjectsWithScores}/12 មុខវិជ្ជា`;
            
            // Populate scores table
            const scoresTable = document.getElementById('studentScoresTable');
            let scoresHtml = '';
            
            student.scores.forEach((score, index) => {
                const grade = getGradeFromScore(score);
                
                scoresHtml += `
                    <tr class="border-b border-gray-100">
                        <td class="py-2 px-3">${index + 1}</td>
                        <td class="py-2 px-3">${subjects[index]}</td>
                        <td class="py-2 px-3 text-center font-bold">${score.toFixed(2)}</td>
                        <td class="py-2 px-3 text-center">
                            <span class="px-2 py-1 rounded text-xs ${getGradeColorClass(grade)}">${grade}</span>
                        </td>
                    </tr>
                `;
            });
            
            scoresTable.innerHTML = scoresHtml;
        }

        // Go back to ranking page
        function goBackToRanking() {
            // Show ranking page
            document.querySelector('main').style.display = 'block';
            document.querySelector('header').style.display = 'block';
            
            // Hide scores page
            document.getElementById('studentScoresPage').classList.add('hidden');
        }

        // Print student scores
        function printStudentScores() {
            // Store current display state
            const originalMain = document.querySelector('main').style.display;
            const originalHeader = document.querySelector('header').style.display;
            const originalScoresPage = document.getElementById('studentScoresPage').classList.contains('hidden');
            
            // Show only scores page for printing
            document.querySelector('main').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            document.getElementById('studentScoresPage').classList.remove('hidden');
            
            // Remove print button from print view
            const printButton = document.querySelector('#studentScoresPage button');
            const originalDisplay = printButton.style.display;
            printButton.style.display = 'none';
            
            // Print
            window.print();
            
            // Restore original state
            printButton.style.display = originalDisplay;
            document.querySelector('main').style.display = originalMain;
            document.querySelector('header').style.display = originalHeader;
            if (originalScoresPage) {
                document.getElementById('studentScoresPage').classList.add('hidden');
            }
        }

        // Export to Excel
        function exportToExcel() {
            if (rankedStudents.length === 0) {
                alert('មិនមានទិន្នន័យសិស្សទេ!');
                return;
            }
            
            // Prepare data for Excel
            const headers = [
                'ល.រ',
                'ឈ្មោះសិស្ស',
                'លេខសម្គាល់',
                'ភេទ',
                'មធ្យមភាគ',
                'កម្រិត',
                'ចំណាត់ថ្នាក់',
                ...subjects
            ];
            
            const rows = rankedStudents.map((student, index) => {
                return [
                    index + 1,
                    student.name,
                    student.id,
                    student.gender === 'male' ? 'ប្រុស' : 'ស្រី',
                    student.average.toFixed(2),
                    student.grade,
                    student.rank,
                    ...student.scores.map(score => score.toFixed(2))
                ];
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            
            // Set column widths
            const wscols = [
                { wch: 5 },  // No.
                { wch: 25 }, // Name
                { wch: 15 }, // ID
                { wch: 8 },  // Gender
                { wch: 12 }, // Average
                { wch: 8 },  // Grade
                { wch: 10 }, // Rank
                ...Array(12).fill({ wch: 10 }) // Subject scores
            ];
            ws['!cols'] = wscols;
            
            // Style header row
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = {c: C, r: 0};
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if (ws[cell_ref]) {
                    ws[cell_ref].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2563EB" } },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                }
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ចំណាត់ថ្នាក់ 10A");
            
            // Generate filename with current date
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
            const filename = `ចំណាត់ថ្នាក់_10A_${dateStr}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
            
            // Show notification
            showNotification('ឯកសារ Excel ត្រូវបានទាញយក!', 'success');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateY(-100px)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Auto-refresh every minute
            setInterval(() => {
                initializeData();
            }, 60000);
        });
    </script>
</body>
</html>