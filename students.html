<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management - Class 10A</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- FileSaver for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
      * {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
      }

      .btn-hover:hover {
        transform: translateY(-2px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .mobile-optimized {
        -webkit-tap-highlight-color: transparent;
      }

      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      @media (max-width: 640px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr) !important;
        }

        .table-cell {
          padding: 0.5rem !important;
          font-size: 0.875rem;
        }

        .action-buttons {
          min-width: 80px;
        }
        
        /* Mobile table styling */
        .mobile-table th,
        .mobile-table td {
          white-space: nowrap;
        }
        
        .mobile-table th:nth-child(1),
        .mobile-table td:nth-child(1) {
          min-width: 50px;
        }
        
        .mobile-table th:nth-child(2),
        .mobile-table td:nth-child(2) {
          min-width: 90px;
        }
        
        .mobile-table th:nth-child(3),
        .mobile-table td:nth-child(3) {
          min-width: 140px;
        }
        
        .mobile-table th:nth-child(4),
        .mobile-table td:nth-child(4) {
          min-width: 70px;
        }
        
        .mobile-table th:nth-child(5),
        .mobile-table td:nth-child(5) {
          min-width: 110px;
        }
        
        .mobile-table th:nth-child(6),
        .mobile-table td:nth-child(6) {
          min-width: 100px;
        }
      }
      
      /* Dropdown styles */
      .export-dropdown {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 0;
        width: 100%;
        z-index: 50;
      }
      
      .export-group:hover .export-dropdown {
        display: block;
      }
      
      .export-dropdown button {
        width: 100%;
        text-align: left;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
      }
      
      .export-dropdown button:hover {
        background-color: #f3f4f6;
      }

      /* Print-specific styles */
      @media print {
        body * {
          visibility: hidden;
        }
        #print-area, #print-area * {
          visibility: visible;
        }
        #print-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 20px;
        }
      }
      
      /* Ensure table scrolls on small screens */
      @media (max-width: 768px) {
        .table-responsive {
          max-height: 500px;
          overflow-y: auto;
        }
      }
      
      /* ID warning badge */
      .id-warning {
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen mobile-optimized">
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md sticky top-0 z-40"
    >
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <a href="index.html" class="flex items-center space-x-2">
              <div class="bg-white p-2 rounded-full">
                <i class="fa-solid fa-arrow-left text-blue-700 text-lg"></i>
              </div>
            </a>
            <h1 class="text-lg font-semibold">បញ្ជីសិស្ស</h1>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-2 py-4">
      <!-- Stats Cards - Mobile Optimized -->
      <div class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <!-- Total Students -->
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <div
                class="text-2xl md:text-3xl font-bold text-blue-600"
                id="totalCount"
              >
                0
              </div>
              <p class="text-gray-600 text-sm">សិស្សសរុប</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <i class="fas fa-users text-blue-600 text-lg"></i>
            </div>
          </div>
        </div>

        <!-- Male Students -->
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <div
                class="text-2xl md:text-3xl font-bold text-blue-500"
                id="maleCount"
              >
                0
              </div>
              <p class="text-gray-600 text-sm">សិស្សប្រុស</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <i class="fas fa-male text-blue-500 text-lg"></i>
            </div>
          </div>
        </div>

        <!-- Female Students -->
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <div
                class="text-2xl md:text-3xl font-bold text-pink-500"
                id="femaleCount"
              >
                0
              </div>
              <p class="text-gray-600 text-sm">សិស្សស្រី</p>
            </div>
            <div class="bg-pink-100 p-3 rounded-lg">
              <i class="fas fa-female text-pink-500 text-lg"></i>
            </div>
          </div>
        </div>

        <!-- Actions Card -->
        <div class="bg-white rounded-xl shadow p-4">
          <div class="space-y-2">
            <a
              href="add-student.html"
              class="w-full block bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 rounded-lg flex items-center justify-center btn-hover mobile-optimized"
            >
              <i class="fas fa-user-plus mr-2"></i>
              <span class="text-sm">បន្ថែមសិស្ស</span>
            </a>
                   
          </div>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="mb-4">
        <div class="relative">
          <input
            type="text"
            id="searchInput"
            class="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="ស្វែងរកសិស្ស..."
          />
          <i
            class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
          ></i>
        </div>
      </div>

      <!-- Student Table -->
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="table-responsive mobile-table">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="table-cell px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  ល.រ
                </th>
                <th
                  class="table-cell px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  អត្តលេខ
                </th>
                <th
                  class="table-cell px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  ឈ្មោះ
                </th>
                <th
                  class="table-cell px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  ភេទ
                </th>
                <th
                  class="table-cell px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  កំណើត
                </th>
                <th
                  class="table-cell px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider action-buttons"
                >
                  សកម្មភាព
                </th>
              </tr>
            </thead>
            <tbody id="studentTable" class="divide-y divide-gray-200">
              <!-- Students will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
          <div
            class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-users text-3xl text-gray-400"></i>
          </div>
          <p class="text-gray-500 text-lg font-medium">
            មិនទាន់មានទិន្នន័យសិស្សទេ
          </p>
          <p class="text-gray-400 text-sm mb-6">No student data available</p>
          <a
            href="add-student.html"
            class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-lg btn-hover mobile-optimized inline-flex items-center"
          >
            <i class="fas fa-user-plus mr-2"></i>
            បន្ថែមសិស្សដំបូង
          </a>
        </div>

        <!-- Table Info -->
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
          <div class="text-sm text-gray-500" id="tableInfo">
            កំពុងបង្ហាញ <span id="showingCount" class="font-bold">0</span> នាក់
          </div>
        </div>
      </div>
    </main>

    <!-- Success Toast -->
    <div
      id="successToast"
      class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 transform transition-transform duration-300 translate-y-full"
    >
      <div class="flex items-center">
        <i class="fas fa-check-circle mr-3 text-lg"></i>
        <span id="toastMessage" class="font-medium">Operation successful!</span>
      </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area" class="hidden">
      <!-- This will be populated when printing -->
    </div>

    <script>
      // Sample data with 10 students
      let students = [];

      // Khmer month names
      const khmerMonths = [
        "មករា",
        "កុម្ភៈ",
        "មីនា",
        "មេសា",
        "ឧសភា",
        "មិថុនា",
        "កក្កដា",
        "សីហា",
        "កញ្ញា",
        "តុលា",
        "វិច្ឆិកា",
        "ធ្នូ"
      ];

      // Helper function to format date in Khmer
      function formatKhmerDate(dateString) {
        const date = new Date(dateString);
        const day = date.getDate();
        const month = khmerMonths[date.getMonth()];
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
      }

      // Helper function to generate consistent 6-digit ID from student data
      function generate6DigitID(student) {
        // Create a consistent hash from student name and dob
        const str = student.name + student.dob;
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        
        // Get 6-digit number (100000 to 999999)
        let num = Math.abs(hash) % 900000 + 100000;
        return num.toString();
      }

      // Validate ID format (6 digits)
      function isValidStudentID(id) {
        return /^\d{6}$/.test(id);
      }

      // Convert existing STU IDs to 6-digit format
      function convertSTUto6Digit(studentArray) {
        const usedIDs = new Set();
        const convertedStudents = [];
        
        // First pass: keep valid 6-digit IDs
        studentArray.forEach(student => {
          if (isValidStudentID(student.id)) {
            usedIDs.add(student.id);
            convertedStudents.push(student);
          }
        });
        
        // Second pass: convert STU IDs
        studentArray.forEach(student => {
          if (!isValidStudentID(student.id)) {
            let newID;
            let attempts = 0;
            
            // Generate unique 6-digit ID
            do {
              newID = generate6DigitID(student);
              attempts++;
              
              // If too many attempts, generate random ID
              if (attempts > 10) {
                newID = Math.floor(100000 + Math.random() * 900000).toString();
              }
            } while (usedIDs.has(newID) && attempts < 20);
            
            usedIDs.add(newID);
            convertedStudents.push({
              ...student,
              id: newID
            });
          }
        });
        
        return convertedStudents;
      }

      // Initialize data
      function initializeData() {
        const savedData = localStorage.getItem("class10A_students");

        if (!savedData) {
          // Add 10 sample students with 6-digit IDs
          students = [
            {
              id: "123456",
              name: "សុខ សារឿន",
              gender: "male",
              dob: "2007-03-15",
              notes: ""
            },
            {
              id: "234567",
              name: "មាស សំណាង",
              gender: "female",
              dob: "2007-05-22",
              notes: ""
            },
            {
              id: "345678",
              name: "វិចិត្រ រស់",
              gender: "male",
              dob: "2007-08-10",
              notes: ""
            },
            {
              id: "456789",
              name: "សុផល ម៉េង",
              gender: "female",
              dob: "2007-01-30",
              notes: ""
            },
            {
              id: "567890",
              name: "រតនា ស៊ីណា",
              gender: "female",
              dob: "2007-07-12",
              notes: ""
            },
            {
              id: "678901",
              name: "ពិសិដ្ឋ ហង្ស",
              gender: "male",
              dob: "2007-04-05",
              notes: ""
            },
            {
              id: "789012",
              name: "សំអាត ចន្ថា",
              gender: "female",
              dob: "2007-11-18",
              notes: ""
            },
            {
              id: "890123",
              name: "ឆាយ រដ្ឋា",
              gender: "male",
              dob: "2007-09-25",
              notes: ""
            },
            {
              id: "901234",
              name: "បញ្ញា វ៉ាន់ដា",
              gender: "female",
              dob: "2007-02-14",
              notes: ""
            },
            {
              id: "012345",
              name: "សុខគង្គ ផល្លី",
              gender: "male",
              dob: "2007-06-08",
              notes: ""
            },
          ];
          localStorage.setItem("class10A_students", JSON.stringify(students));
        } else {
          students = JSON.parse(savedData);
          
          // Check if any students need conversion from STU format
          const hasInvalidIDs = students.some(student => !isValidStudentID(student.id));
          
          if (hasInvalidIDs) {
            students = convertSTUto6Digit(students);
            localStorage.setItem("class10A_students", JSON.stringify(students));
            showToast("ទិន្នន័យត្រូវបានធ្វើបច្ចុប្បន្នភាពទៅលេខ ៦ ខ្ទង់!");
          }
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        initializeData();
        renderTable();
        updateStats();

        // Search functionality
        document
          .getElementById("searchInput")
          .addEventListener("input", function () {
            renderTable();
          });

        // Check if redirected from add/edit page
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("saved") === "true") {
          showToast("សិស្សត្រូវបានរក្សាទុកដោយជោគជ័យ!");
        }
      });

      // Render student table
      function renderTable() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const tableBody = document.getElementById("studentTable");
        const emptyState = document.getElementById("emptyState");

        // Filter students
        const filteredStudents = students.filter(function (student) {
          return (
            student.name.toLowerCase().includes(searchTerm) ||
            student.id.toLowerCase().includes(searchTerm)
          );
        });

        // Update showing count
        document.getElementById("showingCount").textContent =
          filteredStudents.length;

        if (filteredStudents.length === 0) {
          tableBody.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        // Build table rows
        let tableHTML = "";
        filteredStudents.forEach(function (student, index) {
          const genderText = student.gender === "male" ? "ប្រុស" : "ស្រី";
          const genderIcon =
            student.gender === "male"
              ? '<i class="fas fa-mars text-blue-500"></i>'
              : '<i class="fas fa-venus text-pink-500"></i>';

          // Format date using Khmer month names
          const formattedDOB = formatKhmerDate(student.dob);

          // Check ID validity
          const idValid = isValidStudentID(student.id);
          const idClass = idValid ? "text-blue-600 font-mono" : "text-red-600 font-mono id-warning";

          tableHTML += `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="table-cell px-4 py-3 text-center text-gray-700 font-medium">${
                          index + 1
                        }</td>
                        <td class="table-cell px-4 py-3 ${idClass}">
                          ${student.id}
                          ${
                            !idValid 
                              ? '<span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded">៦ខ្ទង់</span>' 
                              : ''
                          }
                        </td>
                        <td class="table-cell px-4 py-3">${student.name}</td>
                        <td class="table-cell px-4 py-3">
                            <div class="flex items-center space-x-2">
                                ${genderIcon}
                                <span>${genderText}</span>
                            </div>
                        </td>
                        <td class="table-cell px-4 py-3 text-gray-600 whitespace-nowrap">${formattedDOB}</td>
                        <td class="table-cell px-4 py-3 action-buttons">
                            <div class="flex space-x-2">
                                <a href="edit-student.html?id=${student.id}" 
                                   class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition mobile-optimized">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="deleteStudent('${
                                  student.id
                                }')" 
                                        class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition mobile-optimized">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tableBody.innerHTML = tableHTML;
      }

      // Update statistics
      function updateStats() {
        const total = students.length;
        const maleCount = students.filter(function (s) {
          return s.gender === "male";
        }).length;
        const femaleCount = students.filter(function (s) {
          return s.gender === "female";
        }).length;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("maleCount").textContent = maleCount;
        document.getElementById("femaleCount").textContent = femaleCount;
      }

      // Delete student
      function deleteStudent(studentId) {
        if (!confirm("តើអ្នកពិតជាចង់លុបសិស្សនេះមែនទេ?")) return;

        students = students.filter(function (s) {
          return s.id !== studentId;
        });
        localStorage.setItem("class10A_students", JSON.stringify(students));

        renderTable();
        updateStats();
        showToast("សិស្សត្រូវបានលុបដោយជោគជ័យ!");
      }

      // Show toast notification
      function showToast(message) {
        const toast = document.getElementById("successToast");
        const toastMessage = document.getElementById("toastMessage");
        
        toastMessage.textContent = message;
        toast.classList.remove("hidden");
        toast.classList.remove("translate-y-full");
        
        setTimeout(() => {
          toast.classList.add("translate-y-full");
          setTimeout(() => {
            toast.classList.add("hidden");
          }, 300);
        }, 3000);
      }

      // =====================
      // PRINT FUNCTION
      // =====================
 
      // Utility function to manually fix all IDs (can be called from console if needed)
      window.fixAllStudentIDs = function() {
        if (confirm("តើអ្នកចង់បំប្លែងអត្តលេខសិស្សទាំងអស់ទៅជា ៦ ខ្ទង់មែនទេ?")) {
          students = convertSTUto6Digit(students);
          localStorage.setItem("class10A_students", JSON.stringify(students));
          renderTable();
          showToast("អត្តលេខសិស្សទាំងអស់ត្រូវបានបំប្លែងជោគជ័យ!");
        }
      }
    </script>
  </body>
</html>