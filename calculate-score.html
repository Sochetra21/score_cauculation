<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>បញ្ចូលពិន្ទុសិស្ស - ថ្នាក់ 10A</title>
    <!-- Tailwind CSS -->
    <script src="./tailwind.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Khmer OS Battambang', sans-serif;
        }
        
        @font-face {
            font-family: 'Khmer OS Battambang';
            src: url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang&display=swap');
        }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .score-cell {
            min-width: 60px;
        }

        .mobile-score-input {
            width: 100%;
            height: 40px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mobile-score-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .mobile-score-input:hover {
            border-color: #9ca3af;
        }

        /* Score colors for better visibility */
        .score-9-10 { background-color: #dcfce7; border-color: #86efac; }
        .score-7-8 { background-color: #dbeafe; border-color: #93c5fd; }
        .score-5-6 { background-color: #fef3c7; border-color: #fcd34d; }
        .score-3-4 { background-color: #fde68a; border-color: #fbbf24; }
        .score-1-2 { background-color: #fecaca; border-color: #f87171; }
        .score-0 { background-color: #f3f4f6; border-color: #d1d5db; }

        .student-row-mobile {
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            .mobile-sticky-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }
            
            .mobile-sticky-column {
                position: sticky;
                left: 0;
                z-index: 5;
                background-color: white;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
            
            .subject-header {
                min-width: 70px;
                max-width: 70px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .swipe-hint {
            animation: swipe 2s infinite;
        }

        @keyframes swipe {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 100;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Progress bar */
        .progress-bar {
            height: 3px;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .fab-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .fab-save.unsaved {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
            50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        }

        /* Subject Management Modal */
        .subject-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .subject-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .subject-item.dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }

        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 4px;
        }

        .drag-handle:hover {
            color: #6b7280;
        }

        /* Decimal input enhancement */
        .decimal-input-hint {
            font-size: 10px;
            color: #6b7280;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        <i class="fas fa-save mr-2"></i>កំពុងរក្សាទុក...
    </div>

    <!-- Floating Save Button -->
    <button onclick="saveAllScores()" class="fab fab-save" id="fabSave" title="រក្សាទុកពិន្ទុ">
        <i class="fas fa-save"></i>
    </button>

    <!-- Header -->
    <header class="header-gradient text-white shadow-lg sticky top-0 z-50">
        <div class="progress-bar" id="saveProgress"></div>
        <div class="container mx-auto px-3 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="bg-white p-2 rounded-full hover:bg-gray-100 transition">
                        <i class="fas fa-arrow-left text-purple-700 text-sm"></i>
                    </a>
                    <div>
                        <h1 class="text-lg font-bold">បញ្ចូលពិន្ទុសិស្ស</h1>
                        <p class="text-xs opacity-90" id="subjectCountDisplay">កំពុងផ្ទុកមុខវិជ្ជា...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="openSubjectManager()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-cog"></i>
                        <span class="hidden md:inline ml-1">គ្រប់គ្រងមុខវិជ្ជា</span>
                    </button>
                    <button onclick="goToRankingPage()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-chart-bar"></i>
                        <span class="hidden md:inline ml-1">មើលចំណាត់ថ្នាក់</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-3 py-4">
        <!-- View 1: Table View (Default) -->
        <div id="view-table" class="view-content">
            <div class="bg-white rounded-lg shadow overflow-hidden mb-4">
                <div class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 border-b">
                    <div class="flex items-center justify-between">
                        <h2 class="font-bold text-gray-800">តារាងបញ្ចូលពិន្ទុ</h2>
                        <div class="text-xs text-gray-600">
                            <span class="swipe-hint"><i class="fas fa-arrows-left-right mr-1"></i>អូសទៅឆ្វេង/ស្ដាំ</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">បញ្ចូលពិន្ទុ 0 ដល់ 10 (អាចប្រើលេខទសភាគ ដូចជា 9.5, 8.75, 7.3, ...) - រក្សាទុកដោយស្វ័យប្រវត្តិរាល់ ៣០ វិនាទី</p>
                    <p class="text-xs text-yellow-600 mt-1 font-medium">
                        <i class="fas fa-lightbulb mr-1"></i>គន្លឹះ៖ អាចបញ្ចូលទសភាគបាន (ដូចជា 8.5, 9.25, 7.75) • ចុច Enter ដើម្បីផ្លាស់ទីទៅក្រឡាបន្ទាប់
                    </p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50" id="tableHeader">
                                <!-- Headers will be populated dynamically -->
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100">
                            <!-- Table will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="p-3 border-t bg-gray-50 text-xs text-gray-600">
                    <div class="flex justify-between items-center">
                        <div>
                            <i class="fas fa-info-circle mr-1"></i>
                            <span>ចុចលើពិន្ទុដើម្បីកែសម្រួល • ពិន្ទុ 0-10 • អូសទៅឆ្វេងសម្រាប់មុខវិជ្ជាផ្សេងទៀត</span>
                        </div>
                        <div id="lastSaveTime" class="text-gray-500">
                            <i class="fas fa-clock mr-1"></i>មិនទាន់រក្សាទុក
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Subject Management Modal -->
    <div id="subjectManagerModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-white rounded-xl w-full max-w-2xl">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold text-lg">គ្រប់គ្រងមុខវិជ្ជា</h3>
                    <button onclick="closeSubjectManager()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4">
                    <div class="mb-6">
                        <p class="text-gray-600 mb-3">បន្ថែម កែសម្រួល ឬលុបមុខវិជ្ជា។ អូសដើម្បីផ្លាស់ប្តូរលំដាប់។</p>
                        
                        <div class="flex space-x-2 mb-4">
                            <input type="text" 
                                   id="newSubjectInput" 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="បញ្ចូលឈ្មោះមុខវិជ្ជាថ្មី...">
                            <button onclick="addNewSubject()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                <i class="fas fa-plus mr-2"></i>បន្ថែម
                            </button>
                        </div>
                        
                        <div id="subjectListContainer" class="space-y-2">
                            <!-- Subject list will be populated here -->
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-bold text-yellow-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>ការព្រមាន</h4>
                        <p class="text-yellow-700 text-sm">
                            ការកែប្រែបញ្ជីមុខវិជ្ជានឹងបោះបង់ពិន្ទុចាស់ទាំងអស់។ 
                            សូមធ្វើការរក្សាទុកមុនពេលកែប្រែ។
                        </p>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end space-x-3">
                    <button onclick="closeSubjectManager()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        បោះបង់
                    </button>
                    <button onclick="saveSubjects()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-save mr-2"></i>រក្សាទុកការផ្លាស់ប្តូរ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let students = [];
        let scores = {};
        let subjects = [];
        let lastSaveTime = null;
        let hasUnsavedChanges = false;
        let autoSaveInterval;

        // Initialize data
        function initializeData() {
            // Load students from class10A_students
            const savedStudents = localStorage.getItem('class10A_students');
            students = savedStudents ? JSON.parse(savedStudents) : [];
            
            // Load subjects from localStorage or use default
            const savedSubjects = localStorage.getItem('class10A_subjects');
            if (savedSubjects) {
                subjects = JSON.parse(savedSubjects);
            } else {
                // Default subjects if none exist
                subjects = [
                    "ការអាន",
                    "ការសរសេរ", 
                    "ការនិយាយ",
                    "ការស្ដាប់",
                    "ចំនួន",
                    "ធរណីមាត្រ",
                    "គំនូរ",
                    "កសិកម្ម",
                    "សីលធម៌-ពលរដ្ឋ",
                    "ព័ត៌មានវិទ្យា",
                    "អប់រំកាយ",
                    "សិល្បៈ"
                ];
                localStorage.setItem('class10A_subjects', JSON.stringify(subjects));
            }
            
            // Update subject count display
            document.getElementById('subjectCountDisplay').textContent = 
                `មុខវិជ្ជា: ${subjects.length} មុខវិជ្ជា`;
            
            // Load scores from class10A_scores
            const savedScores = localStorage.getItem('class10A_scores');
            scores = savedScores ? JSON.parse(savedScores) : {};
            
            // Initialize scores for students who don't have scores yet or adjust for subject count changes
            students.forEach(student => {
                if (!scores[student.id]) {
                    scores[student.id] = Array(subjects.length).fill(0);
                } else if (scores[student.id].length !== subjects.length) {
                    // Adjust scores array length if subject count changed
                    const newScores = Array(subjects.length).fill(0);
                    const minLength = Math.min(scores[student.id].length, subjects.length);
                    for (let i = 0; i < minLength; i++) {
                        newScores[i] = scores[student.id][i];
                    }
                    scores[student.id] = newScores;
                    hasUnsavedChanges = true;
                }
            });
            
            // Load last save time
            lastSaveTime = localStorage.getItem('class10A_lastSave');
            if (lastSaveTime) {
                updateLastSaveDisplay();
            }
            
            renderTableView();
            startAutoSave();
            updateFABAnimation();
        }

        // Update FAB animation
        function updateFABAnimation() {
            const fabSave = document.getElementById('fabSave');
            
            if (hasUnsavedChanges) {
                fabSave.classList.add('unsaved');
                fabSave.title = "រក្សាទុកពិន្ទុ (មានការផ្លាស់ប្តូរ)";
            } else {
                fabSave.classList.remove('unsaved');
                fabSave.title = "រក្សាទុកពិន្ទុ";
            }
        }

        // Start auto-save functionality
        function startAutoSave() {
            // Clear any existing interval
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(() => {
                if (hasUnsavedChanges) {
                    saveAllScores();
                }
            }, 30000);
            
            console.log('Auto-save started (30 second interval)');
        }

        // Render table view
        function renderTableView() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            if (!tableHeader || !tableBody) return;
            
            // Render table headers
            let headerHtml = `
                <th class="py-2 px-3 text-left mobile-sticky-column font-medium">ល.រ</th>
                <th class="py-2 px-3 text-left mobile-sticky-column min-w-[140px] font-medium">ឈ្មោះសិស្ស</th>
            `;
            
            subjects.forEach((subject, index) => {
                const shortName = subject.length > 6 ? subject.substring(0, 6) + '...' : subject;
                headerHtml += `
                    <th class="py-2 px-2 text-center subject-header" title="${subject}">
                        ${shortName}
                    </th>
                `;
            });
            
            tableHeader.innerHTML = headerHtml;
            
            // Render table rows
            let bodyHtml = '';
            
            students.forEach((student, index) => {
                const studentScores = scores[student.id] || Array(subjects.length).fill(0);
                
                bodyHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-3 mobile-sticky-column text-center font-medium bg-gray-50">${index + 1}</td>
                        <td class="py-3 px-3 mobile-sticky-column font-medium">
                            <div class="font-medium text-gray-800">${student.name}</div>
                            <div class="text-xs text-gray-500">${student.id}</div>
                        </td>
                `;
                
                // Add subject scores
                studentScores.forEach((score, subjectIndex) => {
                    const scoreClass = getScoreColorClass(score);
                    const displayScore = score === 0 ? '' : score;
                    
                    bodyHtml += `
                        <td class="py-2 px-2 text-center score-cell">
                            <input type="text" 
                                   value="${displayScore}"
                                   placeholder="0"
                                   class="mobile-score-input ${scoreClass} decimal-input"
                                   data-student="${student.id}"
                                   data-subject="${subjectIndex}"
                                   oninput="handleScoreInput('${student.id}', ${subjectIndex}, this)"
                                   onfocus="this.select()"
                                   onkeydown="handleScoreKeydown(event, '${student.id}', ${subjectIndex}, this)">
                            <div class="decimal-input-hint">0-10</div>
                        </td>
                    `;
                });
                
                bodyHtml += `</tr>`;
            });
            
            tableBody.innerHTML = bodyHtml;
        }

        // Handle score input with full decimal support
        function handleScoreInput(studentId, subjectIndex, inputElement) {
            let value = inputElement.value.trim();
            
            // Allow empty value (for clearing)
            if (value === '') {
                updateScore(studentId, subjectIndex, 0);
                inputElement.value = '';
                return;
            }
            
            // Replace comma with dot for decimal input
            value = value.replace(',', '.');
            
            // Validate that the value is a valid number or decimal
            const isValidDecimal = /^-?\d*\.?\d*$/.test(value);
            if (!isValidDecimal) {
                // Remove invalid characters
                value = value.replace(/[^\d.,-]/g, '');
                inputElement.value = value;
                return;
            }
            
            // If value ends with a dot, allow it for decimal input
            if (value.endsWith('.')) {
                return;
            }
            
            // Parse the decimal value
            let score = parseFloat(value);
            
            // Validate score
            if (isNaN(score)) {
                score = 0;
            }
            
            // Limit to 0-10
            score = Math.max(0, Math.min(10, score));
            
            // Keep up to 2 decimal places
            score = Math.round(score * 100) / 100;
            
            // Update score
            updateScore(studentId, subjectIndex, score);
            
            // Update input value - show full decimal if it has decimal
            if (value.includes('.') || value.includes(',')) {
                inputElement.value = score.toFixed(2).replace(/\.?0+$/, '');
            } else if (score > 0) {
                inputElement.value = score;
            }
        }

        // Handle keyboard events for score input
        function handleScoreKeydown(event, studentId, subjectIndex, inputElement) {
            // Enter key to move to next cell
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // Save the current input first
                handleScoreInput(studentId, subjectIndex, inputElement);
                
                // Get all inputs
                const inputs = Array.from(document.querySelectorAll('.decimal-input'));
                const currentIndex = inputs.indexOf(inputElement);
                
                // Move to next input if exists
                if (currentIndex < inputs.length - 1) {
                    const nextInput = inputs[currentIndex + 1];
                    nextInput.focus();
                    nextInput.select();
                }
                return;
            }
            
            // Allow: backspace, delete, tab, escape, enter
            if ([46, 8, 9, 27, 13].includes(event.keyCode) ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (event.ctrlKey === true && [65, 67, 86, 88].includes(event.keyCode)) ||
                // Allow: home, end, left, right
                (event.keyCode >= 35 && event.keyCode <= 39)) {
                return;
            }
            
            // Allow numbers and decimal point
            if ((event.keyCode >= 48 && event.keyCode <= 57) || // number keys
                (event.keyCode >= 96 && event.keyCode <= 105) || // numpad keys
                event.keyCode === 190 || // decimal point (.)
                event.keyCode === 188 || // comma (,)
                event.keyCode === 110) { // decimal point (numpad)
                return;
            }
            
            // Prevent any other key
            event.preventDefault();
        }

        // Update score with decimal support
        function updateScore(studentId, subjectIndex, value) {
            let score = parseFloat(value);
            if (isNaN(score)) score = 0;
            score = Math.max(0, Math.min(10, score));
            score = Math.round(score * 100) / 100; // Keep 2 decimal places
            
            // Check if score actually changed
            const currentScore = scores[studentId]?.[subjectIndex] || 0;
            if (Math.abs(currentScore - score) < 0.001) return;
            
            // Update scores object
            if (!scores[studentId]) {
                scores[studentId] = Array(subjects.length).fill(0);
            }
            scores[studentId][subjectIndex] = score;
            
            // Mark as unsaved
            hasUnsavedChanges = true;
            
            // Update FAB animation
            updateFABAnimation();
            
            // Update input color
            updateInputColor(studentId, subjectIndex, score);
        }

        // Update input color
        function updateInputColor(studentId, subjectIndex, score) {
            const scoreClass = getScoreColorClass(score);
            
            // Find and update input
            const input = document.querySelector(
                `.decimal-input[data-student="${studentId}"][data-subject="${subjectIndex}"]`
            );
            
            if (input) {
                // Remove existing score classes
                input.classList.remove('score-9-10', 'score-7-8', 'score-5-6', 'score-3-4', 'score-1-2', 'score-0');
                // Add new class
                input.classList.add(scoreClass);
            }
        }

        // Get score color class
        function getScoreColorClass(score) {
            if (score >= 9) return 'score-9-10';
            if (score >= 7) return 'score-7-8';
            if (score >= 5) return 'score-5-6';
            if (score >= 3) return 'score-3-4';
            if (score >= 1) return 'score-1-2';
            return 'score-0';
        }

        // Save all scores
        function saveAllScores() {
            if (!hasUnsavedChanges && Object.keys(scores).length > 0) {
                return; // No changes to save
            }
            
            // Show saving indicator
            showAutoSaveIndicator();
            
            // Save scores to localStorage
            localStorage.setItem('class10A_scores', JSON.stringify(scores));
            
            // Update last save time
            lastSaveTime = new Date().toISOString();
            localStorage.setItem('class10A_lastSave', lastSaveTime);
            
            // Update display
            updateLastSaveDisplay();
            
            // Reset unsaved changes flag
            hasUnsavedChanges = false;
            
            // Update FAB animation
            updateFABAnimation();
            
            console.log('Scores saved to localStorage:', lastSaveTime);
        }

        // Show auto-save indicator
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            const progressBar = document.getElementById('saveProgress');
            
            // Show progress animation
            progressBar.style.width = '100%';
            indicator.style.display = 'flex';
            
            setTimeout(() => {
                indicator.style.display = 'none';
                progressBar.style.width = '0%';
            }, 2000);
        }

        // Update last save time display
        function updateLastSaveDisplay() {
            if (!lastSaveTime) return;
            
            const lastSaveElement = document.getElementById('lastSaveTime');
            if (!lastSaveElement) return;
            
            const saveTime = new Date(lastSaveTime);
            const now = new Date();
            const diffMs = now - saveTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            let displayText;
            if (diffMins < 1) {
                displayText = 'ទើបតែរក្សាទុក';
            } else if (diffMins < 60) {
                displayText = `រក្សាទុក ${diffMins} នាទីមុន`;
            } else {
                const diffHours = Math.floor(diffMins / 60);
                displayText = `រក្សាទុក ${diffHours} ម៉ោងមុន`;
            }
            
            lastSaveElement.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-1"></i>${displayText}`;
        }

        // Navigate to ranking page
        function goToRankingPage() {
            // First save any unsaved changes
            if (hasUnsavedChanges) {
                saveAllScores();
            }
            
            // Navigate to ranking page
            window.location.href = 'ranking.html';
        }

        // Open subject manager modal
        function openSubjectManager() {
            renderSubjectList();
            document.getElementById('subjectManagerModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close subject manager modal
        function closeSubjectManager() {
            document.getElementById('subjectManagerModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Render subject list for management
        function renderSubjectList() {
            const container = document.getElementById('subjectListContainer');
            let html = '';
            
            subjects.forEach((subject, index) => {
                html += `
                    <div class="subject-item" data-index="${index}" draggable="true">
                        <div class="flex items-center">
                            <div class="drag-handle mr-3">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <span class="font-medium">${index + 1}. ${subject}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editSubject(${index})" class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded hover:bg-blue-200">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="removeSubject(${index})" class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded hover:bg-red-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add drag and drop functionality
            setupDragAndDrop();
        }

        // Setup drag and drop for subjects
        function setupDragAndDrop() {
            const container = document.getElementById('subjectListContainer');
            let draggedItem = null;
            
            container.querySelectorAll('.subject-item').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (draggedItem && draggedItem !== this) {
                        const fromIndex = parseInt(draggedItem.getAttribute('data-index'));
                        const toIndex = parseInt(this.getAttribute('data-index'));
                        
                        // Swap subjects in array
                        [subjects[fromIndex], subjects[toIndex]] = [subjects[toIndex], subjects[fromIndex]];
                        
                        // Update scores for all students
                        students.forEach(student => {
                            if (scores[student.id]) {
                                [scores[student.id][fromIndex], scores[student.id][toIndex]] = 
                                [scores[student.id][toIndex], scores[student.id][fromIndex]];
                            }
                        });
                        
                        hasUnsavedChanges = true;
                        updateFABAnimation();
                        renderSubjectList();
                    }
                });
            });
        }

        // Add new subject
        function addNewSubject() {
            const input = document.getElementById('newSubjectInput');
            const subjectName = input.value.trim();
            
            if (!subjectName) {
                alert('សូមបញ្ចូលឈ្មោះមុខវិជ្ជា!');
                return;
            }
            
            if (subjects.includes(subjectName)) {
                alert('មុខវិជ្ជានេះមានរួចហើយ!');
                return;
            }
            
            // Add new subject
            subjects.push(subjectName);
            
            // Add score column for all students
            students.forEach(student => {
                if (!scores[student.id]) {
                    scores[student.id] = [];
                }
                scores[student.id].push(0);
            });
            
            // Clear input
            input.value = '';
            
            // Update display
            hasUnsavedChanges = true;
            updateFABAnimation();
            renderSubjectList();
            
            // Update subject count display
            document.getElementById('subjectCountDisplay').textContent = 
                `មុខវិជ្ជា: ${subjects.length} មុខវិជ្ជា`;
        }

        // Edit subject
        function editSubject(index) {
            const newName = prompt('កែសម្រួលឈ្មោះមុខវិជ្ជា:', subjects[index]);
            
            if (newName && newName.trim() && newName.trim() !== subjects[index]) {
                subjects[index] = newName.trim();
                hasUnsavedChanges = true;
                updateFABAnimation();
                renderSubjectList();
            }
        }

        // Remove subject
        function removeSubject(index) {
            if (!confirm(`តើអ្នកពិតជាចង់លុបមុខវិជ្ជា "${subjects[index]}" មែនទេ?\n\nពិន្ទុទាំងអស់សម្រាប់មុខវិជ្ជានេះនឹងត្រូវបានលុប។`)) {
                return;
            }
            
            // Remove subject
            subjects.splice(index, 1);
            
            // Remove scores for this subject from all students
            students.forEach(student => {
                if (scores[student.id]) {
                    scores[student.id].splice(index, 1);
                }
            });
            
            // Update display
            hasUnsavedChanges = true;
            updateFABAnimation();
            renderSubjectList();
            
            // Update subject count display
            document.getElementById('subjectCountDisplay').textContent = 
                `មុខវិជ្ជា: ${subjects.length} មុខវិជ្ជា`;
        }

        // Save subjects changes
        function saveSubjects() {
            // Save subjects to localStorage
            localStorage.setItem('class10A_subjects', JSON.stringify(subjects));
            
            // Save updated scores
            localStorage.setItem('class10A_scores', JSON.stringify(scores));
            
            // Update last save time
            lastSaveTime = new Date().toISOString();
            localStorage.setItem('class10A_lastSave', lastSaveTime);
            
            // Update all views
            renderTableView();
            updateLastSaveDisplay();
            
            // Reset unsaved changes flag
            hasUnsavedChanges = false;
            updateFABAnimation();
            
            // Close modal
            closeSubjectManager();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Prevent accidental navigation
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'ពិន្ទុមិនទាន់រក្សាទុកទេ។ តើអ្នកពិតជាចង់ចាកចេញមែនទេ?';
                    return 'ពិន្ទុមិនទាន់រក្សាទុកទេ។ តើអ្នកពិតជាចង់ចាកចេញមែនទេ?';
                }
            });
            
            // Auto-save when page becomes visible (user returns to tab)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && hasUnsavedChanges) {
                    saveAllScores();
                }
            });
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+S or Cmd+S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveAllScores();
                }
                
                // Escape to close modal
                if (e.key === 'Escape') {
                    const subjectModal = document.getElementById('subjectManagerModal');
                    if (!subjectModal.classList.contains('hidden')) {
                        closeSubjectManager();
                    }
                }
                
                // Arrow keys for navigation between inputs
                if (e.target.classList.contains('decimal-input')) {
                    const inputs = Array.from(document.querySelectorAll('.decimal-input'));
                    const currentIndex = inputs.indexOf(e.target);
                    
                    if (e.key === 'ArrowRight' && currentIndex < inputs.length - 1) {
                        e.preventDefault();
                        inputs[currentIndex + 1].focus();
                        inputs[currentIndex + 1].select();
                    } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
                        e.preventDefault();
                        inputs[currentIndex - 1].focus();
                        inputs[currentIndex - 1].select();
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        // Move to same column, next row
                        const studentId = e.target.dataset.student;
                        const subjectIndex = parseInt(e.target.dataset.subject);
                        const currentStudentIndex = students.findIndex(s => s.id === studentId);
                        if (currentStudentIndex < students.length - 1) {
                            const nextStudentId = students[currentStudentIndex + 1].id;
                            const nextInput = document.querySelector(
                                `.decimal-input[data-student="${nextStudentId}"][data-subject="${subjectIndex}"]`
                            );
                            if (nextInput) {
                                nextInput.focus();
                                nextInput.select();
                            }
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        // Move to same column, previous row
                        const studentId = e.target.dataset.student;
                        const subjectIndex = parseInt(e.target.dataset.subject);
                        const currentStudentIndex = students.findIndex(s => s.id === studentId);
                        if (currentStudentIndex > 0) {
                            const prevStudentId = students[currentStudentIndex - 1].id;
                            const prevInput = document.querySelector(
                                `.decimal-input[data-student="${prevStudentId}"][data-subject="${subjectIndex}"]`
                            );
                            if (prevInput) {
                                prevInput.focus();
                                prevInput.select();
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>